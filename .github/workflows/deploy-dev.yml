name: Deploy to Dev Server
on:
  pull_request:
    types: [closed]
    branches:
      - dev

jobs:
  deploy:
    if: github.event.pull_request.merged == true
    runs-on: self-hosted
    environment: Dev
    steps:
      - name: Checkout code
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1

      - name: Setup Node.js
        uses: actions/setup-node@60edb5dd545a775178f52524783378180af0d1f8 # v4.0.2
        with:
          node-version: "20"

      - name: Create .env file
        run: |
          echo "VITE_API_BASE_URL=${{ vars.VITE_API_BASE_URL }}" > .env
          echo "BACKEND_URL=${{ vars.BACKEND_URL }}" >> .env
          echo "BFF_PORT=${{ vars.BFF_PORT }}" >> .env
          echo "ALLOWED_ORIGINS=${{ vars.ALLOWED_ORIGINS }}" >> .env
          echo "NODE_TLS_REJECT_UNAUTHORIZED=${{ vars.NODE_TLS_REJECT_UNAUTHORIZED }}" >> .env

      - name: Build Docker images using docker compose
        run: |
          docker compose build

      - name: Save Docker images
        run: |
          docker save sai-deal-assistant-frontend-frontend:latest -o frontend.tar
          docker save sai-deal-assistant-frontend-bff:latest -o bff.tar
          docker save sai-deal-assistant-frontend-proxy:latest -o proxy.tar

      - name: Copy files to dev server
        env:
          DEV_PASSWORD: ${{ secrets.DEV_SERVER_PASSWORD }}
        run: |
          # Use recursive scp to copy directories (bff/certs)
          sshpass -p "$DEV_PASSWORD" scp -r -P ${{ vars.DEV_SERVER_SSH_PORT }} -o StrictHostKeyChecking=no \
            frontend.tar bff.tar proxy.tar docker-compose.yml .env deploy-dev.sh docker/proxy/proxy.conf bff/certs/ \
            ${{ vars.DEV_SERVER_SSH_USER }}@${{ vars.DEV_SERVER_HOST }}:/tmp/

      - name: Deploy on dev server
        env:
          DEV_PASSWORD: ${{ secrets.DEV_SERVER_PASSWORD }}
          DEV_SERVER_HOST: ${{ vars.DEV_SERVER_HOST }}
        run: |
          sshpass -p "$DEV_PASSWORD" ssh -p ${{ vars.DEV_SERVER_SSH_PORT }} -o StrictHostKeyChecking=no \
            ${{ vars.DEV_SERVER_SSH_USER }}@${{ vars.DEV_SERVER_HOST }} \
            'chmod +x /tmp/deploy-dev.sh && /tmp/deploy-dev.sh'
