name: Auto Create Pull Requests

on:
  push:
    branches-ignore:
      - dev
      - main

jobs:
  create-pull-requests:
    runs-on: [self-hosted, linux]
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1
        with:
          fetch-depth: 0

      - name: Get current branch name
        id: branch
        run: echo "name=${GITHUB_REF#refs/heads/}" >> $GITHUB_OUTPUT

      - name: Check and create PR to dev (via REST API)
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PAT || github.token }}
        run: |
          set -e
          BRANCH="${{ steps.branch.outputs.name }}"
          OWNER="$(echo $GITHUB_REPOSITORY | cut -d'/' -f1)"
          REPO="$(echo $GITHUB_REPOSITORY | cut -d'/' -f2)"
          LIST_URL="https://api.github.com/repos/$OWNER/$REPO/pulls?head=${OWNER}:$BRANCH&base=dev"

          echo "Checking existing PRs for $BRANCH -> dev..."
          curl -s -H "Authorization: token $GITHUB_TOKEN" "$LIST_URL" -o /tmp/prs.json
          NUM=$(python - <<'PY'
import sys, json
data=json.load(open('/tmp/prs.json'))
print(len(data))
PY
)
          if [ "$NUM" -gt 0 ]; then
            NUM0=$(python - <<'PY'
import json
data=json.load(open('/tmp/prs.json'))
print(data[0]['number'])
PY
)
            echo "PR to dev already exists: #$NUM0"
          else
            echo "Creating PR to dev branch..."
            python - <<'PY' > /tmp/payload.json
import os, json
branch = os.environ['BRANCH']
obj = {"title": f"[{branch}] Merge to dev", "head": branch, "base": "dev", "body": f"Auto-generated PR from {branch} to dev branch"}
print(json.dumps(obj))
PY
            curl -s -H "Authorization: token $GITHUB_TOKEN" -H "Content-Type: application/json" -d @/tmp/payload.json "https://api.github.com/repos/$OWNER/$REPO/pulls" -o /tmp/create_pr.json
            CREATED=$(python - <<'PY'
import json
print(json.load(open('/tmp/create_pr.json'))['number'])
PY
)
            echo "Created PR #$CREATED"
          fi

      - name: Check and create PR to main (via REST API)
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PAT || github.token }}
        run: |
          set -e
          BRANCH="${{ steps.branch.outputs.name }}"
          OWNER="$(echo $GITHUB_REPOSITORY | cut -d'/' -f1)"
          REPO="$(echo $GITHUB_REPOSITORY | cut -d'/' -f2)"
          LIST_URL="https://api.github.com/repos/$OWNER/$REPO/pulls?head=${OWNER}:$BRANCH&base=main"

          echo "Checking existing PRs for $BRANCH -> main..."
          curl -s -H "Authorization: token $GITHUB_TOKEN" "$LIST_URL" -o /tmp/prs.json
          NUM=$(python - <<'PY'
import sys, json
data=json.load(open('/tmp/prs.json'))
print(len(data))
PY
)
          if [ "$NUM" -gt 0 ]; then
            NUM0=$(python - <<'PY'
import json
data=json.load(open('/tmp/prs.json'))
print(data[0]['number'])
PY
)
            echo "PR to main already exists: #$NUM0"
          else
            echo "Creating PR to main branch..."
            python - <<'PY' > /tmp/payload.json
import os, json
branch = os.environ['BRANCH']
obj = {"title": f"[{branch}] Merge to main", "head": branch, "base": "main", "body": f"Auto-generated PR from {branch} to main branch"}
print(json.dumps(obj))
PY
            curl -s -H "Authorization: token $GITHUB_TOKEN" -H "Content-Type: application/json" -d @/tmp/payload.json "https://api.github.com/repos/$OWNER/$REPO/pulls" -o /tmp/create_pr.json
            CREATED=$(python - <<'PY'
import json
print(json.load(open('/tmp/create_pr.json'))['number'])
PY
)
            echo "Created PR #$CREATED"
          fi
