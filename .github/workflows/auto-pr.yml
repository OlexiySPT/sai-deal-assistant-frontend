name: Auto Create Pull Requests

on:
  push:
    branches-ignore:
      - dev
      - main

jobs:
  create-pull-requests:
    runs-on: [self-hosted, linux]
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1
        with:
          fetch-depth: 0

      - name: Get current branch name
        id: branch
        run: echo "name=${GITHUB_REF#refs/heads/}" >> $GITHUB_OUTPUT

      - name: Check and create PR to dev (via API)
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_PAT || github.token }}
          script: |
            const branch = `${{ steps.branch.outputs.name }}`;
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            // Search for an existing PR with base=dev and head=owner:branch
            const existing = await github.rest.pulls.list({ owner, repo, base: 'dev', head: `${owner}:${branch}` });
            if (existing.data && existing.data.length > 0) {
              console.log(`PR to dev already exists: #${existing.data[0].number}`);
            } else {
              console.log('Creating PR to dev branch...');
              const created = await github.rest.pulls.create({ owner, repo, title: `[${branch}] Merge to dev`, head: branch, base: 'dev', body: `Auto-generated PR from ${branch} to dev branch` });
              console.log(`Created PR #${created.data.number}`);
            }

      - name: Check and create PR to main (via API)
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_PAT || github.token }}
          script: |
            const branch = `${{ steps.branch.outputs.name }}`;
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const existing = await github.rest.pulls.list({ owner, repo, base: 'main', head: `${owner}:${branch}` });
            if (existing.data && existing.data.length > 0) {
              console.log(`PR to main already exists: #${existing.data[0].number}`);
            } else {
              console.log('Creating PR to main branch...');
              const created = await github.rest.pulls.create({ owner, repo, title: `[${branch}] Merge to main`, head: branch, base: 'main', body: `Auto-generated PR from ${branch} to main branch` });
              console.log(`Created PR #${created.data.number}`);
            }
